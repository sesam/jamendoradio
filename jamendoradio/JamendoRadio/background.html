<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<script src="Theme/jquery-1.3.2.min.js" />
<script type="text/javascript">
    //State variables
    var IsPlaying;
    var IsReady;
    var CurrentData;
    var CurrentPosition;
    var AlbumImageLoaded;
    //Position changed callback (this updates the gui in popup.html)
    var OnPositionChanged;
    var OnImageLoaded;

    //Internals
    var audio = new Audio();
    var playList;
    var currentAPICall;
	var loop;
	var timeKeeper;
	var volume = 1;
	
	var as = new scrobbler("http://post.audioscrobbler.com/", "jmn", "1.0");
	var js = new scrobbler("http://postaudioscrobbler.jamendo.com/", "jmn", "1.0");
	
    audio.addEventListener("ended", function() {
		if(IsPlaying) Next();
	}, false);
	audio.addEventListener("playing", function() {
		if(new_song) { new_song = false; as.NowPlaying(); js.NowPlaying(); }
	}, false);
	
    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
        if (request.target) {
            switch (request.target) {
                case "manipulatePage": sendResponse({ GoAhead: eval(localStorage["SiteIntegration"]) }); return;
                case "loadAlbumPlayList": LoadAlbum(request.data); break;
                case "loadTrackPlayList": LoadTrack(request.data); break;
                case "loadArtistRadio": LoadArtist(request.data); break;
                case "loadPlayList": LoadPlayList(request.data); break;
                case "loadRadioPlayList": LoadJamRadio(request.data); break;
				case "scrobbleReady": sendResponse(as.IsReady()); return;
				case "scrobbleInit": InitScrobble(); break;
            }
            sendResponse();
        }
        else
            sendResponse({});
    });

    function PopulatePlaylist(settings, asRadio, onLoadCallback, prefetch) {
        var url;
        if (!prefetch) {
			Unload("loading");
			if (!settings) settings = "/?order=ratingmonth_desc";
            url = "http://api.jamendo.com/get2/name+id+stream+album_name+album_url+album_image+artist_name+artist_url/track/json/track_album+album_artist" + settings;
			
            if (asRadio) {
                loop = false;
				url += "&n=5";
				if(url.indexOf("order=random") == -1)
					url += "&nshuffle=500";
                currentAPICall = url;
            } else loop = true;
        } else url = currentAPICall;

        if (timeKeeper) return; //Prevent spamming
        timeKeeper = setTimeout(function () { timeKeeper = null; }, 1500);
		
		console.log("Making request for playlist items.");
        var req = new XMLHttpRequest();
        req.open("GET", url, true);
        req.onload = function () {
            playList = eval(req.responseText);

            if (playList.length < 1) { Unload("empty"); return; }
            IsReady = true;

            if (!prefetch) SetPlaylistPosition(0);
            if (onLoadCallback) onLoadCallback();
        };
		req.send(null);
    }
	function LoadTrack(id) {
	    var settings = "/?id=" + id;
	    PopulatePlaylist(settings, false, Play, false);
	}
	function LoadArtist(name) {
	    var settings = "/?order=random&";
	    settings += "artist_idstr=" + name;

	    PopulatePlaylist(settings, true, Play, false);
	}
	function LoadTags(name) {
	    var settings = "+album_tag/?order=random&";
	    settings += "tag_idstr=" + name;

	    PopulatePlaylist(settings, true, Play, false);
	}
    function LoadAlbum(id, asRadio) {
        var settings = "/?order=";
        if (asRadio) settings += "random&";
        else settings += "numalbum_asc&";
        settings += "album_id=" + id;

        PopulatePlaylist(settings, asRadio, Play, false);
	}
	function LoadJamRadio(id, asRadio) {
	    var settings = "+radio_track_inradioplaylist/?order=";
	    if (asRadio) settings += "random&";
	    else settings += "numradio_asc&";
	    settings += "radio_id=" + id;

	    PopulatePlaylist(settings, asRadio, Play, false);
    }
    function LoadPlayList(id, asRadio) {
        var settings = "+playlist_track/?order=";
        if (asRadio) settings += "random&";
        else settings += "numplaylist_asc&";
        settings += "playlist_id=" + id;

        PopulatePlaylist(settings, asRadio, Play, false);
    }
    function LoadUserStarred(user) {
        var settings = "+album_user_starred/?order=random&";
        settings += "user_idstr=" + user;
		
        PopulatePlaylist(settings, true, Play, false);
    }
	function LoadStation(config) {
		PopulatePlaylist(config, true, Play, false);
	}
	
	var new_song = false;
    function SetPlaylistPosition(position) {
		var oldAlbumImage = CurrentData.album_image;
        CurrentPosition = position; CurrentData = playList[CurrentPosition];
		
		as.Submit(); js.Submit(); //Submit previous track, if it exists...
        
        if (CurrentPosition >= (playList.length - 1)) { //Last song in playlist.
            CurrentPosition = -1;
            if (!loop) PopulatePlaylist(null, null, null, true);//If not looping a fixed playlist, prefetch new songs from jamendo.
        }
		
		if(CurrentData) {
		    audio.src = CurrentData.stream;
		    audio.volume = 1;
			audio.load(); 
			new_song = true;
			
			if(CurrentData.album_image != oldAlbumImage) {
				AlbumImageLoaded = false;
				if (OnPositionChanged) OnPositionChanged();
	            var albumImage = document.createElement("img");
	            albumImage.onload = function () { AlbumImageLoaded = true; if (OnImageLoaded) OnImageLoaded(); }
				albumImage.src = CurrentData.album_image;
			}
			else {
				AlbumImageLoaded = true;
				if (OnPositionChanged) OnPositionChanged();
			}
			
		}
		else Unload();
    }
	
    function Play() {
        if (IsReady) {
            audio.play();
            if (volume) audio.volume = volume;
            IsPlaying = true;
        }
    }
    function Pause() {
        if (IsReady) {
            if (audio.paused)
                Play();
            else {
                audio.pause(); 
                IsPlaying = false;
            }
        }
    }
    function Next() {
        if (IsReady) {
            SetPlaylistPosition(CurrentPosition + 1);
            if (IsPlaying) Play();
        }
    }
    function Back() {
        if (IsReady && loop) {
            var newPosition = 0;
			if (playList.length == 1) SetPlaylistPosition(newPosition); 
            else if (CurrentPosition == -1) newPosition = playList.length - 2; //Playing the last song...
			else if (CurrentPosition == 0) newPosition = playList.length - 1;  //Playing the first song...
			else newPosition = CurrentPosition - 1;
			
            SetPlaylistPosition(newPosition);
            if (IsPlaying) Play();
        }
    }

	//Set volume
	function setVolume(value) {
	    audio.volume = value;
	    volume = value;
	}
	
    //Stops playing and remove current playlist.
    function Unload(status) {
		as.Submit(); js.Submit();
        audio.src = "";
        audio.load();
        playList = null;
		currentAPICall = "";
        IsReady = false;
        IsPlaying = false;
        switch(status) {
            case "empty":
                CurrentData = { "name": "Radio failure...", "album_name": "The query failed to", "artist_name": "find any songs.", "album_image": "Images/splash.jpg" };
    			AlbumImageLoaded = false;
                break;
            case "loading":
                CurrentData = { "name": "Radio loading...", "album_name": "Please wait while", "artist_name": "I fetch some songs.", "album_image": "Images/splash.jpg" };
    			AlbumImageLoaded = false;
                break;
		    default:
    			CurrentData = { "name": "No radio loaded", "album_name": "Please select a", "artist_name": "channel below...", "album_image": "Images/splash.jpg" };
	    		AlbumImageLoaded = true;
		}

        CurrentPosition = -1;

        if (OnPositionChanged)
            OnPositionChanged(CurrentData);
    }
    Unload();
	
	function InitScrobble() {
		if(!eval(localStorage["Scrobble"])) return;
		var usr = eval(localStorage["ScrobbleUsername"]);
		var pwd = eval(localStorage["ScrobblePassword"]);
		
		as.Handshake(usr, pwd);
	}
	if(eval(localStorage["Scrobble"])) InitScrobble();
	
	function scrobbler(endpoint, clientId, clientVersion) {
    var _endpoint = endpoint;
    var _clientId = clientId;
    var _clientVersion = clientVersion;

    var _ready = false; var _sessionId; var _np_url; var _sub_url;
    this.Handshake = function(user, passwordHash) {
		if(!eval(localStorage["Scrobble"])) return;
		if(!user || !passwordHash) return;
		
        var ts = Math.round(new Date().getTime() / 1000);
        var auth_token = hex_md5(passwordHash + ts);
        var post_string = sformat("?hs=true&p=1.2.1&c={0}&v={1}&t={2}&u={3}&a={4}", _clientId, _clientVersion, ts, user, auth_token);

        var req = new XMLHttpRequest();
        req.open("GET", _endpoint + post_string, true);
        req.onload = function() {
			var data = req.responseText.split('\n');
			if(data[0] == "OK") {
				_ready = true;
				_sessionId = data[1];
				_np_url = data[2];
				_sub_url = data[3];
				console.log("Handshake completed, " + user + " is now logged in to endpoint " + _endpoint + ".");
				console.log("Response: " + req.responseText);
			} else {
				console.log("Request failed");
				_ready = false;
				_sessionId = ""; _np_url = ""; _sub_url = "";
			} 
        }
        req.send(null);
    }

	var _cd;
    this.NowPlaying = function() {
		if(!_ready || !eval(localStorage["Scrobble"])) return;
		if(CurrentData.artist_name == "# Psytrance Brazil #") { //DIRTY DIRTY!!!
			var fixedArtist; var fixedAlbum; var fixedTrack; var dashIndex;
			
			if(CurrentData.album_name.indexOf('-') > -1) {
				dashIndex = CurrentData.album_name.indexOf('-');
				fixedAlbum = CurrentData.album_name.substr(dashIndex + 1);
				fixedArtist = CurrentData.album_name.substr(0, dashIndex - 1);
			} else fixedAlbum = CurrentData.album_name;
			if(CurrentData.name.indexOf('-') > -1) {
				dashIndex = CurrentData.name.indexOf('-');
				fixedTrack = CurrentData.name.substr(dashIndex + 1);
				fixedArtist = CurrentData.name.substr(0, dashIndex - 1);
			} else fixedTrack = CurrentData.name;
			if(!fixedArtist || !fixedAlbum || !fixedTrack) return;
			_cd = {
				'a':urlencode(fixedArtist),
				'b':urlencode(fixedAlbum),
				't':urlencode(fixedTrack),
				'l':Math.round(audio.duration),
				'n':"",
				'm':"",
				'i':Math.round(new Date().getTime() / 1000)		
			}
		} else {
			_cd = {
				'a':urlencode(CurrentData.artist_name),
				'b':urlencode(CurrentData.album_name),
				't':urlencode(CurrentData.name),
				'l':Math.round(audio.duration),
				'n':"",
				'm':"",
				'i':Math.round(new Date().getTime() / 1000)
			};
		}
		
		if(_endpoint.indexOf('jamendo') > -1)
			_cd.m = urlencode("jamendo.com/track/" + CurrentData.id);
		
		
		var post_string = sformat("?s={0}&a={1}&b={2}&t={3}&l={4}&n={5}&m={6}",
			_sessionId, _cd.a, _cd.b, _cd.t, _cd.l, _cd.n, _cd.m);
			
		console.log('Submitting NowPlaying for track "' + _cd.t + '".');
		var req = new XMLHttpRequest();
        req.open("POST", _np_url + post_string, true);
        req.onload = function() {
			console.log("Response: " + req.responseText);
        }
        req.send(null);
   }
    this.Submit = function() {
		if(!_ready || !eval(localStorage["Scrobble"]) || !_cd) return;
		if(_cd.l < 30)
			console.log('Track "' + _cd.t + '" is too short for scrobbling.');
		var cts = Math.round(new Date().getTime() / 1000);
		
		if((cts - _cd.i >= 240) || (cts - _cd.i > _cd.l / 2)) {
			var post_string = sformat("?s={0}&o[0]=P&r[0]=&a[0]={1}&b[0]={2}&t[0]={3}&l[0]={4}&n[0]={5}&i[0]={6}&m[0]={7}",
				_sessionId, _cd.a, _cd.b, _cd.t, _cd.l, _cd.n, _cd.i, _cd.m);
			
			console.log('Submitting scrobble for track "' + _cd.t + '".');
			var req = new XMLHttpRequest();
			req.open("POST", _sub_url + post_string, true);
			req.onload = function() {
				console.log("Response: " + req.responseText);
			}
			req.send(null);
		}
		else console.log('Track "' + _cd.t + '" has been prematurely ended, and does not qualify for scrobbling.');
		_submit_keeper = false;
		_cd = undefined;
    }

	this.IsReady = function() {
		return _ready && eval(localStorage["Scrobble"]);
	}
	
	function urlencode(str) { return escape(str).replace('+', '%2B').replace('%20', '+').replace('*', '%2A').replace('/', '%2F').replace('@', '%40'); }
    function sformat(inString, v1, v2, v3, v4, v5, v6, v7, v8, v9, v10) { return inString.replace(/{(\d)}/g, function(m) { switch (m) { case "{0}": return v1; case "{1}": return v2; case "{2}": return v3; case "{3}": return v4; case "{4}": return v5; case "{5}": return v6; case "{6}": return v7; case "{7}": return v8; case "{8}": return v9; case "{9}": return v10; } return ""; }); }
	var hexcase = 0; function hex_md5(a) { return rstr2hex(rstr_md5(str2rstr_utf8(a))) } function hex_hmac_md5(a, b) { return rstr2hex(rstr_hmac_md5(str2rstr_utf8(a), str2rstr_utf8(b))) } function md5_vm_test() { return hex_md5("abc").toLowerCase() == "900150983cd24fb0d6963f7d28e17f72" } function rstr_md5(a) { return binl2rstr(binl_md5(rstr2binl(a), a.length * 8)) } function rstr_hmac_md5(c, f) { var e = rstr2binl(c); if (e.length > 16) { e = binl_md5(e, c.length * 8) } var a = Array(16), d = Array(16); for (var b = 0; b < 16; b++) { a[b] = e[b] ^ 909522486; d[b] = e[b] ^ 1549556828 } var g = binl_md5(a.concat(rstr2binl(f)), 512 + f.length * 8); return binl2rstr(binl_md5(d.concat(g), 512 + 128)) } function rstr2hex(c) { try { hexcase } catch (g) { hexcase = 0 } var f = hexcase ? "0123456789ABCDEF" : "0123456789abcdef"; var b = ""; var a; for (var d = 0; d < c.length; d++) { a = c.charCodeAt(d); b += f.charAt((a >>> 4) & 15) + f.charAt(a & 15) } return b } function str2rstr_utf8(c) { var b = ""; var d = -1; var a, e; while (++d < c.length) { a = c.charCodeAt(d); e = d + 1 < c.length ? c.charCodeAt(d + 1) : 0; if (55296 <= a && a <= 56319 && 56320 <= e && e <= 57343) { a = 65536 + ((a & 1023) << 10) + (e & 1023); d++ } if (a <= 127) { b += String.fromCharCode(a) } else { if (a <= 2047) { b += String.fromCharCode(192 | ((a >>> 6) & 31), 128 | (a & 63)) } else { if (a <= 65535) { b += String.fromCharCode(224 | ((a >>> 12) & 15), 128 | ((a >>> 6) & 63), 128 | (a & 63)) } else { if (a <= 2097151) { b += String.fromCharCode(240 | ((a >>> 18) & 7), 128 | ((a >>> 12) & 63), 128 | ((a >>> 6) & 63), 128 | (a & 63)) } } } } } return b } function rstr2binl(b) { var a = Array(b.length >> 2); for (var c = 0; c < a.length; c++) { a[c] = 0 } for (var c = 0; c < b.length * 8; c += 8) { a[c >> 5] |= (b.charCodeAt(c / 8) & 255) << (c % 32) } return a } function binl2rstr(b) { var a = ""; for (var c = 0; c < b.length * 32; c += 8) { a += String.fromCharCode((b[c >> 5] >>> (c % 32)) & 255) } return a } function binl_md5(p, k) { p[k >> 5] |= 128 << ((k) % 32); p[(((k + 64) >>> 9) << 4) + 14] = k; var o = 1732584193; var n = -271733879; var m = -1732584194; var l = 271733878; for (var g = 0; g < p.length; g += 16) { var j = o; var h = n; var f = m; var e = l; o = md5_ff(o, n, m, l, p[g + 0], 7, -680876936); l = md5_ff(l, o, n, m, p[g + 1], 12, -389564586); m = md5_ff(m, l, o, n, p[g + 2], 17, 606105819); n = md5_ff(n, m, l, o, p[g + 3], 22, -1044525330); o = md5_ff(o, n, m, l, p[g + 4], 7, -176418897); l = md5_ff(l, o, n, m, p[g + 5], 12, 1200080426); m = md5_ff(m, l, o, n, p[g + 6], 17, -1473231341); n = md5_ff(n, m, l, o, p[g + 7], 22, -45705983); o = md5_ff(o, n, m, l, p[g + 8], 7, 1770035416); l = md5_ff(l, o, n, m, p[g + 9], 12, -1958414417); m = md5_ff(m, l, o, n, p[g + 10], 17, -42063); n = md5_ff(n, m, l, o, p[g + 11], 22, -1990404162); o = md5_ff(o, n, m, l, p[g + 12], 7, 1804603682); l = md5_ff(l, o, n, m, p[g + 13], 12, -40341101); m = md5_ff(m, l, o, n, p[g + 14], 17, -1502002290); n = md5_ff(n, m, l, o, p[g + 15], 22, 1236535329); o = md5_gg(o, n, m, l, p[g + 1], 5, -165796510); l = md5_gg(l, o, n, m, p[g + 6], 9, -1069501632); m = md5_gg(m, l, o, n, p[g + 11], 14, 643717713); n = md5_gg(n, m, l, o, p[g + 0], 20, -373897302); o = md5_gg(o, n, m, l, p[g + 5], 5, -701558691); l = md5_gg(l, o, n, m, p[g + 10], 9, 38016083); m = md5_gg(m, l, o, n, p[g + 15], 14, -660478335); n = md5_gg(n, m, l, o, p[g + 4], 20, -405537848); o = md5_gg(o, n, m, l, p[g + 9], 5, 568446438); l = md5_gg(l, o, n, m, p[g + 14], 9, -1019803690); m = md5_gg(m, l, o, n, p[g + 3], 14, -187363961); n = md5_gg(n, m, l, o, p[g + 8], 20, 1163531501); o = md5_gg(o, n, m, l, p[g + 13], 5, -1444681467); l = md5_gg(l, o, n, m, p[g + 2], 9, -51403784); m = md5_gg(m, l, o, n, p[g + 7], 14, 1735328473); n = md5_gg(n, m, l, o, p[g + 12], 20, -1926607734); o = md5_hh(o, n, m, l, p[g + 5], 4, -378558); l = md5_hh(l, o, n, m, p[g + 8], 11, -2022574463); m = md5_hh(m, l, o, n, p[g + 11], 16, 1839030562); n = md5_hh(n, m, l, o, p[g + 14], 23, -35309556); o = md5_hh(o, n, m, l, p[g + 1], 4, -1530992060); l = md5_hh(l, o, n, m, p[g + 4], 11, 1272893353); m = md5_hh(m, l, o, n, p[g + 7], 16, -155497632); n = md5_hh(n, m, l, o, p[g + 10], 23, -1094730640); o = md5_hh(o, n, m, l, p[g + 13], 4, 681279174); l = md5_hh(l, o, n, m, p[g + 0], 11, -358537222); m = md5_hh(m, l, o, n, p[g + 3], 16, -722521979); n = md5_hh(n, m, l, o, p[g + 6], 23, 76029189); o = md5_hh(o, n, m, l, p[g + 9], 4, -640364487); l = md5_hh(l, o, n, m, p[g + 12], 11, -421815835); m = md5_hh(m, l, o, n, p[g + 15], 16, 530742520); n = md5_hh(n, m, l, o, p[g + 2], 23, -995338651); o = md5_ii(o, n, m, l, p[g + 0], 6, -198630844); l = md5_ii(l, o, n, m, p[g + 7], 10, 1126891415); m = md5_ii(m, l, o, n, p[g + 14], 15, -1416354905); n = md5_ii(n, m, l, o, p[g + 5], 21, -57434055); o = md5_ii(o, n, m, l, p[g + 12], 6, 1700485571); l = md5_ii(l, o, n, m, p[g + 3], 10, -1894986606); m = md5_ii(m, l, o, n, p[g + 10], 15, -1051523); n = md5_ii(n, m, l, o, p[g + 1], 21, -2054922799); o = md5_ii(o, n, m, l, p[g + 8], 6, 1873313359); l = md5_ii(l, o, n, m, p[g + 15], 10, -30611744); m = md5_ii(m, l, o, n, p[g + 6], 15, -1560198380); n = md5_ii(n, m, l, o, p[g + 13], 21, 1309151649); o = md5_ii(o, n, m, l, p[g + 4], 6, -145523070); l = md5_ii(l, o, n, m, p[g + 11], 10, -1120210379); m = md5_ii(m, l, o, n, p[g + 2], 15, 718787259); n = md5_ii(n, m, l, o, p[g + 9], 21, -343485551); o = safe_add(o, j); n = safe_add(n, h); m = safe_add(m, f); l = safe_add(l, e) } return Array(o, n, m, l) } function md5_cmn(h, e, d, c, g, f) { return safe_add(bit_rol(safe_add(safe_add(e, h), safe_add(c, f)), g), d) } function md5_ff(g, f, k, j, e, i, h) { return md5_cmn((f & k) | ((~f) & j), g, f, e, i, h) } function md5_gg(g, f, k, j, e, i, h) { return md5_cmn((f & j) | (k & (~j)), g, f, e, i, h) } function md5_hh(g, f, k, j, e, i, h) { return md5_cmn(f ^ k ^ j, g, f, e, i, h) } function md5_ii(g, f, k, j, e, i, h) { return md5_cmn(k ^ (f | (~j)), g, f, e, i, h) } function safe_add(a, d) { var c = (a & 65535) + (d & 65535); var b = (a >> 16) + (d >> 16) + (c >> 16); return (b << 16) | (c & 65535) } function bit_rol(a, b) { return (a << b) | (a >>> (32 - b)) };
}
</script>
</head><body><div id="player"></div></body></html>
