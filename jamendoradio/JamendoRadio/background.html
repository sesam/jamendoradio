<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<script src="Theme/jquery-1.3.2.min.js" />
<script type="text/javascript">
    //State variables
    var IsPlaying;
    var IsReady;
    var CurrentData;
    var CurrentPosition;
    var AlbumImageLoaded;
    //Position changed callback (this updates the gui in popup.html)
    var OnPositionChanged;
    var OnImageLoaded;

    //Internals
    var audio = new Audio();
    var playList;
    var currentAPICall;
	var loop;
	var timeKeeper;
	var volume = 1;
	

    //Check if the current song has ended, and advance playlist to next item if that is the case.
    setInterval(function() { if (IsPlaying && audio.ended) Next(); }, 250);

    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
        if (request.target) {
            switch (request.target) {
                case "manipulatePage": sendResponse({ GoAhead: eval(localStorage["SiteIntegration"]) }); return;
                case "loadAlbumPlayList": LoadAlbum(request.data); break;
                case "loadTrackPlayList": LoadTrack(request.data); break;
                case "loadArtistRadio": LoadArtist(request.data); break;
                case "loadPlayList": LoadPlayList(request.data); break;
                case "loadRadioPlayList": LoadJamRadio(request.data); break;
            }
            sendResponse();
        }
        else
            sendResponse({});
    });

    function PopulatePlaylist(settings, asRadio, onLoadCallback, prefetch) {
        var url;
		console.log("Entereing method: PopulatePlaylist");
        if (!prefetch) {
			Unload("loading");
			if (!settings) settings = "/?order=ratingmonth_desc";
            url = "http://api.jamendo.com/get2/name+stream+album_name+album_url+album_image+artist_name+artist_url/track/json/track_album+album_artist" + settings;
			
            if (asRadio) {
                loop = false;
				url += "&n=5";
				if(url.indexOf("order=random") == -1)
					url += "&nshuffle=500";
                currentAPICall = url;
            } else loop = true;
        } else url = currentAPICall;
		console.log("url: " + url);

        if (timeKeeper) return; //Prevent spamming
        timeKeeper = setTimeout(function () { timeKeeper = null; }, 1500);
		
		console.log("Making request.");
        var req = new XMLHttpRequest();
        req.open("GET", url, true);
        req.onload = function () {
            playList = eval(req.responseText);

            if (playList.length < 1) { Unload("empty"); return; }
            IsReady = true;

            if (!prefetch) SetPlaylistPosition(0);
            if (onLoadCallback) onLoadCallback();
        };
		req.send(null);
    }
	function LoadTrack(id) {
	    var settings = "/?id=" + id;
	    PopulatePlaylist(settings, false, Play, false);
	}
	function LoadArtist(name) {
	    var settings = "/?order=random&";
	    settings += "artist_idstr=" + name;

	    PopulatePlaylist(settings, true, Play, false);
	}
	function LoadTags(name) {
	    var settings = "+album_tag/?order=random&";
	    settings += "tag_idstr=" + name;

	    PopulatePlaylist(settings, true, Play, false);
	}
    function LoadAlbum(id, asRadio) {
        var settings = "/?order=";
        if (asRadio) settings += "random&";
        else settings += "numalbum_asc&";
        settings += "album_id=" + id;

        PopulatePlaylist(settings, asRadio, Play, false);
	}
	function LoadJamRadio(id, asRadio) {
	    var settings = "+radio_track_inradioplaylist/?order=";
	    if (asRadio) settings += "random&";
	    else settings += "numradio_asc&";
	    settings += "radio_id=" + id;

	    PopulatePlaylist(settings, asRadio, Play, false);
    }
    function LoadPlayList(id, asRadio) {
        var settings = "+playlist_track/?order=";
        if (asRadio) settings += "random&";
        else settings += "numplaylist_asc&";
        settings += "playlist_id=" + id;

        PopulatePlaylist(settings, asRadio, Play, false);
    }
    function LoadUserStarred(user) {
        var settings = "+album_user_starred/?order=random&";
        settings += "user_idstr=" + user;
		
        PopulatePlaylist(settings, true, Play, false);
    }
	function LoadStation(config) {
		PopulatePlaylist(config, true, Play, false);
	}
	
    function SetPlaylistPosition(position) {
		var oldAlbumImage = CurrentData.album_image;
        CurrentPosition = position; CurrentData = playList[CurrentPosition];
        
        if (CurrentPosition >= (playList.length - 1)) { //Last song in playlist.
            CurrentPosition = -1;
            if (!loop) PopulatePlaylist(null, null, null, true);//If not looping a fixed playlist, prefetch new songs from jamendo.
        }
		
		if(CurrentData) {
		    audio.src = CurrentData.stream;
		    audio.volume = 1;
			audio.load();
			
			if(CurrentData.album_image != oldAlbumImage) {
				AlbumImageLoaded = false;
				if (OnPositionChanged) OnPositionChanged();
	            var albumImage = document.createElement("img");
	            albumImage.onload = function () { AlbumImageLoaded = true; if (OnImageLoaded) OnImageLoaded(); }
				albumImage.src = CurrentData.album_image;
			}
			else {
				AlbumImageLoaded = true;
				if (OnPositionChanged) OnPositionChanged();
			}
		}
		else Unload();
    }
	
    function Play() {
        if (IsReady) {
            audio.play();
            if (volume) audio.volume = volume;
            IsPlaying = true;
        }
    }

    //Toggles play pause
    function Pause() {
        if (IsReady) {
            if (audio.paused)
                Play();
            else {
                audio.pause(); 
                IsPlaying = false;
            }
        }
    }

    //Loads the next song.
    function Next() {
        if (IsReady) {
            SetPlaylistPosition(CurrentPosition + 1);
            if (IsPlaying) Play();
        }
    }
    function Back() {
        if (IsReady && loop) {
            var newPosition = 0;
			if (playList.length == 1) SetPlaylistPosition(newPosition); 
            else if (CurrentPosition == -1) newPosition = playList.length - 2; //Playing the last song...
			else if (CurrentPosition == 0) newPosition = playList.length - 1;  //Playing the first song...
			else newPosition = CurrentPosition - 1;
			
            SetPlaylistPosition(newPosition);
            if (IsPlaying) Play();
        }
    }

	//Set volume
	function setVolume(value) {
	    audio.volume = value;
	    volume = value;
	}

	
    //Stops playing and remove current playlist.
    function Unload(status) {
        audio.src = "";
        audio.load();
        playList = null;
		currentAPICall = "";
        IsReady = false;
        IsPlaying = false;
        switch(status) {
            case "empty":
                CurrentData = { "name": "Radio failure...", "album_name": "The query failed to", "artist_name": "find any songs.", "album_image": "Images/splash.jpg" };
    			AlbumImageLoaded = false;
                break;
            case "loading":
                CurrentData = { "name": "Radio loading...", "album_name": "Please wait while", "artist_name": "I fetch some songs.", "album_image": "Images/splash.jpg" };
    			AlbumImageLoaded = false;
                break;
		    default:
    			CurrentData = { "name": "No radio loaded", "album_name": "Please select a", "artist_name": "channel below...", "album_image": "Images/splash.jpg" };
	    		AlbumImageLoaded = true;
		}

        CurrentPosition = -1;

        if (OnPositionChanged)
            OnPositionChanged(CurrentData);
    }
    Unload();
</script>
</head><body><div id="player"></div></body></html>
