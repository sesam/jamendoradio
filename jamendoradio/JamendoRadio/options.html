<html>
<head>
    <title>Jamendo Radio Configuration</title>

    <script src="script/util.js"></script>
    <script type="text/javascript">
        var idCounter = 0;
		setInterval(function() {
			chrome.extension.sendRequest({target: "scrobbleReady"}, function(response) { 
				if(response) $("#scrobblestatus").css('color', 'green').text('Connection detected');
				else $("#scrobblestatus").css('color', 'red').text('No connection');			
			});
		}, 250); 
		
        function save_channels() {
            var options = new Array();
			$(".channelRow").each(function() { options[options.length] = { "Name":this.children[1].children[0].value, "Subset": this.children[3].children[0].value }; });
			
            localStorage["Stations"] = JSON.stringify(options);
		}
		
		function restore_channels() {
            $(".channel").remove();
			
			var stations = eval(localStorage["Stations"]);
			for (i = 0; i < stations.length; i++) {
                AddChannel(stations[i].Name, stations[i].Subset);
            }		
		}
		
		function save_options() {
			localStorage["SiteIntegration"] = JSON.stringify(document.getElementById("pageIntegration").checked);
            localStorage["SkipDefault"] = JSON.stringify(document.getElementById("skipDefault").checked);
			localStorage["Scrobble"] = JSON.stringify(document.getElementById("scrobble").checked);
			
			var usr = document.getElementById("scrUsername").value;
			var pwd = document.getElementById("scrPassword").value;
			
			if(usr && pwd) {
				localStorage["ScrobbleUsername"] = JSON.stringify(usr);
				localStorage["ScrobblePassword"] = JSON.stringify(hex_md5(pwd));
				
				document.getElementById("scrPassword").value = ""; pwd = "";
			}
			
			chrome.extension.sendRequest({target: "scrobbleInit"},function(response){});
		}
		
        function restore_options() {
			document.getElementById("pageIntegration").checked = eval(localStorage["SiteIntegration"]);
			document.getElementById("skipDefault").checked = eval(localStorage["SkipDefault"]);
			document.getElementById("scrobble").checked = eval(localStorage["Scrobble"]);
			
			document.getElementById("scrUsername").value = eval(localStorage["ScrobbleUsername"]) || "";
			/* No point in restoring the password. It's been eaten up by the MD5 algorithm */
        }

		function sformat(inString, v1, v2, v3, v4, v5, v6, v7, v8, v9, v10) {
			return inString.replace(/{(\d)}/g, function(m) { 
				switch(m) {
					case "{0}": return v1;
					case "{1}": return v2;
					case "{2}": return v3;
					case "{3}": return v4;
					case "{4}": return v5;
					case "{5}": return v6;
					case "{6}": return v7;
					case "{7}": return v8;
					case "{8}": return v9;
					case "{9}": return v10;
				}
				return "";
			});
		}
		
		function AddChannel(name, config) {
			var ident = "channel_" + idCounter++;
			
			var newHTML = "<li id='{0}' class='ui-state-default channel'>" +
				"<table><tr class='channelRow'><td class='move'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span></td>" +
				"<td class='nameContainer'><input class='channelName' value='{1}' /></td>" +
				"<td class='edit'><span class='ui-icon ui-icon-pencil' onclick=\"$('#editor_{0}').removeAttr('disabled');\"></span></td>" +
				"<td class='configContainer'><input id='editor_{0}' class='channelConfig' value='{2}' disabled='true' /></td>" +
				"<td class='trash'><span class='ui-icon ui-icon-trash' onclick='$(\"#{0}\").remove();'></span></td></tr></table></li>";
			$("#channels").append(sformat(newHTML, ident, name, config));
		}
		
        function CreateChannel() {
            if (!newName.value) { alert("Please pick a name for this station"); return; }
            if (!newSet.value && !newOrder.value) { alert("Please specify sort order"); return; }
            if (newSet.value && !newValues.value) { alert("Please specify criteria"); return; }
            if (newValues.value && newValues.value.indexOf(' ') > -1) { alert("Criteria may not contain spaces.\nSeparate them by placing one on each row..."); return; }
			if (newSet.value == "user" && newValues.value.indexOf("\n") > -1 ) { alert("You may only fetch albums from a single user."); return; }
			var config = "";
						
			switch (newSet.value) {
				case "tag":
					config = "+album_tag/?tag_idstr=" + newValues.value.replace(/\n/mg, '+');
					if(newOrder.value) config += "&order=" + newOrder.value;
					break;
				case "artist":
					config = "/?order=random&artist_idstr=" + newValues.value.replace(/\n/mg, '+');
					break;
				case "album":
					config = "/?order=random&album_id=" + newValues.value.replace(/\n/mg, '+');
					break;
				case "playlist":
					config = "+playlist_track/?order=random&playlist_id=" + newValues.value.replace(/\n/mg, '+');
					break;
				case "jamradio":
					config = "+radio_track_inradioplaylist/?order=random&radio_id=" + newValues.value.replace(/\n/mg, '+');
					break;
				case "user":
					config = "+album_user_starred/?order=random&user_idstr=" + newValues.value.replace(/\n/mg, '+');
					break;
				default:
					config = "/?order=" + newOrder.value;
			}
			
            AddChannel(newName.value, config); ClearDesigner();
			return true;
        }
		function ClearDesigner() {
			$('#designer input').add('#designer textarea').val('');
			$('#designer select').attr('selectedIndex', 0);
			
			newValues.disabled = true;
			newOrder.disabled = false;
		}
		$(function() {
			$("#channels").sortable();
			$("#channels").disableSelection();
			$(".fg-button:not(.ui-state-disabled)")
				.hover(
					function(){ 
						$(this).addClass("ui-state-hover"); 
					},
					function(){ 
						$(this).removeClass("ui-state-hover"); 
					}
				)
				.mousedown(function(){
						$(this).parents('.fg-buttonset-single:first').find(".fg-button.ui-state-active").removeClass("ui-state-active");
						if( $(this).is('.ui-state-active.fg-button-toggleable, .fg-buttonset-multi .ui-state-active') ){ $(this).removeClass("ui-state-active"); }
						else { $(this).addClass("ui-state-active"); }	
				})
				.mouseup(function(){
					if(! $(this).is('.fg-button-toggleable, .fg-buttonset-single .fg-button,  .fg-buttonset-multi .fg-button') ){
						$(this).removeClass("ui-state-active");
					}
				});
			$(".contextMenu").mouseleave(function() { $(this).hide(500); });
			setTimeout(function(){$("#accordion").fadeIn(500).accordion({ fillSpace: true, changestart: function(event, ui)	{ cIndex = parseInt(ui.newHeader.attr("index")); } });},150);

		});
		var cIndex = 0;
		$(window).resize(function() { $("#accordion").fadeOut(500, function() { $("#accordion").accordion('destroy').fadeIn(500).accordion({ fillSpace: true, changestart: function(event, ui)	{ cIndex = parseInt(ui.newHeader.attr("index")); }, active: cIndex }); }); });
    </script>

    <style type="text/css">
        @import url(styles/options/jquery-ui-1.7.2.custom.css);
        body
        {
            overflow: hidden; padding-bottom:15px; /*Annoying status bar fix!*/
        }
        ul
        {
            list-style-type: none;
        }
        .channel
        {
            white-space: nowrap;
        }
        .channel input
        {
            width: 100%;
        }
        .channel table
        {
            width: 100%;
        }
        .nameContainer
        {
            width: 250px;
        }
        .channelConfig
        {
            width: 100%;
        }
        .move, .edit
        {
            width: 30px;
        }
        .trash span, .edit span
        {
            float: right;
        }
        .nameTitle
        {
            margin: 0 250px 0 50px;
        }
        .configTitle
        {
            width: 65%;
        }
        .inputBox
        {
            width: 250px;
        }
        .inputBox input, .inputBox select, .inputBox textarea
        {
            width: 100%;
        }
        .fg-button
        {
            outline: 0;
            margin: 0 4px 0 0;
            padding: .4em 1em;
            text-decoration: none !important;
            cursor: pointer;
            position: relative;
            text-align: center;
            zoom: 1;
        }
        .fg-button .ui-icon
        {
            position: absolute;
            top: 50%;
            margin-top: -8px;
            left: 50%;
            margin-left: -8px;
        }
        a.fg-button
        {
            float: left;
        }
        .fg-button-icon-left
        {
            padding-left: 2.1em;
        }
        .fg-button-icon-right
        {
            padding-right: 2.1em;
        }
        .fg-button-icon-left .ui-icon
        {
            right: auto;
            left: .2em;
            margin-left: 0;
        }
        .fg-button-icon-right .ui-icon
        {
            left: auto;
            right: .2em;
            margin-left: 0;
        }
        .fg-button-icon-solo
        {
            display: block;
            width: 8px;
            text-indent: -9999px;
        }
        /* solo icon buttons must have block properties for the text-indent to work */.fg-buttonset
        {
            float: left;
        }
        .fg-buttonset .fg-button
        {
            float: left;
        }
        .fg-buttonset-single .fg-button, .fg-buttonset-multi .fg-button
        {
            margin-right: -1px;
        }
        .fg-toolbar
        {
            padding: .5em;
            margin: 0;
        }
        .fg-toolbar .fg-buttonset
        {
            margin-right: 1.5em;
            padding-left: 1px;
        }
        .fg-toolbar .fg-button
        {
            font-size: 1em;
        }
        .contextMenu
        {
            position: absolute;
            overflow: hidden;
        }
        .contextMenu ul
        {
            -webkit-padding-start: 4px;
            padding-left: 4px;
			font: 18px 'Segoe UI', Arial, sans-serif;
        }
		.contextMenu li
		{
			margin-bottom: 4px;
		}
    </style>
</head>
<body onload="restore_options(); restore_channels();">
    <div id="accordion" class="ui-helper-hidden">
        <h3 index="0">
            <a href="#">Jamendo Radio</a></h3>
        <div>
            <div class="fg-toolbar ui-widget-header ui-corner-all ui-helper-clearfix">
                <div class="fg-buttonset fg-buttonset ui-helper-clearfix">
                    <button class="fg-button ui-state-default fg-button-icon-left ui-corner-all" onclick="restore_options();">
                        <span class="ui-icon ui-icon-refresh"></span>Restore</button>
                    <button class="fg-button ui-state-default fg-button-icon-left ui-corner-all" onclick="save_options();">
                        <span class="ui-icon ui-icon-disk"></span>Save</button>
                </div>
            </div><br />
                <fieldset class="ui-corner-all">
                    <legend>
                        <input type="checkbox" id="pageIntegration" style="width: 25px;" />Integrate with
                        Jamendo.com</legend>Activate this option to manipulate the play buttons on jamendo
                    web pages so that they start the music within Jamendo Radio (this extension).
                </fieldset>
                <br />
                <fieldset class="ui-corner-all">
                    <legend>
                        <input type="checkbox" id="skipDefault" style="width: 25px;" />Skip default channel.</legend>
                    Prevent the popup window from adding the Default channel.</fieldset>
				<br />
				<fieldset class="ui-corner-all">
					<legend>
						<input type="checkbox" id="scrobble" style="width: 25px;" />Scrobble to AudioScrobbler (last.fm)</legend>
							<div id="scrobblestatus" style="float:right;"></div>
							Send information of what music this extension is playing to AudioScrobbler.
							You need an account at <a href="www.last.fm">Last.fm</a> for this to work.<br /><br />
							<span style="margin:0 5px 0 25px;">Username</span><input id="scrUsername" /><br />
							<span style="margin:0 8px 0 25px;">Password</span><input id="scrPassword" type="password" /><br />
							<i>Note: Changes to credentials will only occur when both username and password is entered.
								To turn scrobbling on or off, please use the checkbox.</i>
							
        </div>
        <h3 index="1">
            <a href="#" id="channelButton">Channels</a></h3>
        <div>
            <div class="fg-toolbar ui-widget-header ui-corner-all ui-helper-clearfix">
                <div class="fg-buttonset ui-helper-clearfix">
                    <button class="fg-button ui-state-default fg-button-icon-left ui-corner-all" onclick="restore_channels();">
                        <span class="ui-icon ui-icon-refresh"></span>Restore</button>
                    <button class="fg-button ui-state-default fg-button-icon-left ui-corner-all" onclick="$('#presetContext').css('left', event.pageX -5).css('top', event.pageY -5).show(500)">
                        <span class="ui-icon ui-icon-plus"></span>Add preset</button>
                    <button class="fg-button ui-state-default fg-button-icon-left ui-corner-all" onclick="save_channels();">
                        <span class="ui-icon ui-icon-disk"></span>Save</button>
                </div>
            </div>
            <p>
                <span class="nameTitle">Name</span> <span class="configTitle">Configuration string</span>
            </p>
            <ul id="channels">
            </ul>
        </div>
        <h3 index="2">
            <a href="#">Channel designer</a></h3>
        <div id="designer">
            <div class="fg-toolbar ui-widget-header ui-corner-all ui-helper-clearfix">
                <div class="fg-buttonset fg-buttonset ui-helper-clearfix">
                    <button class="fg-button ui-state-default fg-button-icon-left ui-corner-all" onclick="ClearDesigner();">
                        <span class="ui-icon ui-icon-minus"></span>Clear</button>
                    <button class="fg-button ui-state-default fg-button-icon-left ui-corner-all" onclick="if(CreateChannel())$('#channelButton').click();">
                        <span class="ui-icon ui-icon-plus"></span>Add channel</button>
                </div>
            </div>
            <p>
                <table style="color: white;">
                    <tr>
                        <td>
                            <fieldset class="ui-corner-all inputBox">
                                <legend>Name</legend>
                                <input id="newName" /></fieldset>
                            <fieldset class="ui-corner-all inputBox">
                                <legend>Base</legend>
                                <select id="newSet" onchange="newValues.disabled = this.selectedIndex == 0; newOrder.disabled = this.selectedIndex > 1;">
                                    <option value="">Everyting</option>
                                    <option value="tag">Tag(s)</option>
                                    <option value="artist">Artist(s)</option>
                                    <option value="album">Album(s)</option>
                                    <option value="playlist">Playlist(s)</option>
                                    <option value="jamradio">JamRadio(s)</option>
                                    <option value="user">User starred albums</option>
                                </select></fieldset>
                            <fieldset class="ui-corner-all inputBox">
                                <legend>Tendency</legend>
                                <select id="newOrder">
                                    <option value="random">Completely Random</option>
                                    <option value="releasedate_desc">Release date</option>
                                    <option value="rating_desc">Rating</option>
                                    <option value="ratingweek_desc">Rating (weekly)</option>
                                    <option value="ratingmonth_desc">Rating (monthy)</option>
                                    <option value="playlisted_desc">Playlisted</option>
                                    <option value="downloaded_desc">Downloaded</option>
                                    <option value="listened_desc">Listened</option>
                                    <option value="starred_desc">Favourited</option>
                                </select></fieldset>
                        </td>
                        <td style="vertical-align: top;">
                            <fieldset class="ui-corner-all inputBox">
                                <legend>Criteria</legend>
                                <textarea id="newValues" rows="6" cols="25" disabled="disabled" onblur="this.value = this.value.replace(/\n+/, '\n').replace(/\n*$/, '');"></textarea></fieldset>
                        </td>
                    </tr>
                </table>
            </p>
        </div>
    </div>
    <div id="presetContext" class="ui-helper-hidden ui-widget-header ui-corner-all contextMenu">
        <ul style="width: 300px;">
            <li class="fg-button ui-state-default ui-corner-all" onclick="$('#jamradioContext').css('left', event.pageX -5).css('top', event.pageY -5).show(500)">
                JamRadios...</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="$('#electronicaContext').css('left', event.pageX -5).css('top', event.pageY -5).show(500)">
                Electronica...</li>
			<li class="fg-button ui-state-default ui-corner-all" onclick="$('#popContext').css('left', event.pageX -5).css('top', event.pageY -5).show(500)">
                Pop and rock...</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="$('#classicContext').css('left', event.pageX -5).css('top', event.pageY -5).show(500)">
                Acoustic and classical...</li>
        </ul>
    </div>
    <div id="jamradioContext" class="ui-helper-hidden ui-widget-header ui-corner-all contextMenu">
        <ul style="width: 300px;">
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Dance / Electro', '+radio_track_inradioplaylist/?order=random&radio_id=4');">
                Dance / Electro</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Hip-Hop', '+radio_track_inradioplaylist/?order=random&radio_id=5');">
                Hip-Hop</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Jazz', '+radio_track_inradioplaylist/?order=random&radio_id=6');">
                Jazz</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Lounge', '+radio_track_inradioplaylist/?order=random&radio_id=7');">
                Lounge</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Metal', '+radio_track_inradioplaylist/?order=random&radio_id=283');">
                Metal</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Pop / Songwriting', '+radio_track_inradioplaylist/?order=random&radio_id=8');">
                Pop / Songwriting</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Rock', '+radio_track_inradioplaylist/?order=random&radio_id=9');">
                Rock</li>
        </ul>
    </div>
	<div id="electronicaContext" class="ui-helper-hidden ui-widget-header ui-corner-all contextMenu">
        <ul style="width: 300px;">
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Trance/Goa', '/?order=random&artist_idstr=subatomicglue+psydom+nexus+red.nebula+secret.side+xl.ant+six');">
                Trance/Goa</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Chillout', '+album_tag/?tag_idstr=ambient+chillout&order=rating_desc');">
                Chillout</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('8-Bit / Demoscene', '+album_tag/?tag_idstr=8bit+demoscene&order=starred_desc');">
                8-Bit / Demoscene</li>
        </ul>
    </div>
    <div id="popContext" class="ui-helper-hidden ui-widget-header ui-corner-all contextMenu">
        <ul style="width: 300px;">
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Indie Pop', '/?order=random&album_id=20784+7098+23755+43195+6339+56070+9604+38655+53847');">
                Indie pop</li>
			<li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Folk', '+album_tag/?tag_idstr=chanson+folk&order=rating_desc');">
                Folk</li>
			<li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Rock', '+album_tag/?tag_idstr=progressive+rock&order=rating_desc');">
                Rock</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Metal', '/?order=random&artist_idstr=antarhes+holy.pain+cynism+weirdland+scoldt+nocreeps+arai');">
                Metal</li>			
        </ul>
    </div>
	<div id="classicContext" class="ui-helper-hidden ui-widget-header ui-corner-all contextMenu">
        <ul style="width: 300px;">
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Piano', '/?order=random&album_id=29114+29279+2007+53704+55571+56448+45056+44920+45611');">
                Piano</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Orchestral', '/?order=random&album_id=43099+38846+44547+4383+3097+16649+36771');">
                Orchestral</li>
            <li class="fg-button ui-state-default ui-corner-all" onclick="AddChannel('Opera', '+album_tag/?tag_idstr=opera&order=rating_desc');">
                Opera</li>
        </ul>
    </div></body>
</html>
